<?php
$usuariocomunicado = [
    ['id' => 1, 'nombre' => 'Nombre de la empresa numero uno', 'estado' => 0, 'whatsapp'=> '573102640456', 'email' => 'mauricio@creativosweb.com.co'],
    ['id' => 2, 'nombre' => 'Nombre de la empresa numero dos', 'estado' => 1, 'whatsapp'=> '573102640457', 'email' => 'ana@creativosweb.com.co'],
    ['id' => 3, 'nombre' => 'Nombre de la empresa numero tres', 'estado' => 0, 'whatsapp'=> '573102640458', 'email' => 'juan@creativosweb.com.co'],
    ['id' => 4, 'nombre' => 'Nombre de la empresa numero cuatro', 'estado' => 1, 'whatsapp'=> '573102640459', 'email' => 'maria@creativosweb.com.co'],
    ['id' => 5, 'nombre' => 'Nombre de la empresa numero cinco', 'estado' => 0, 'whatsapp'=> '573102640460', 'email' => 'carlos@creativosweb.com.co'],
    ['id' => 6, 'nombre' => 'Nombre de la empresa numero seis', 'estado' => 1, 'whatsapp'=> '573102640461', 'email' => 'elena@creativosweb.com.co'],
    ['id' => 7, 'nombre' => 'Nombre de la empresa numero siete', 'estado' => 0, 'whatsapp'=> '573102640462', 'email' => 'lucas@creativosweb.com.co'],
    ['id' => 8, 'nombre' => 'Nombre de la empresa numero ocho', 'estado' => 1, 'whatsapp'=> '573102640463', 'email' => 'sandra@creativosweb.com.co'],
    ['id' => 9, 'nombre' => 'Nombre de la empresa numero nueve', 'estado' => 0, 'whatsapp'=> '573102640464', 'email' => 'gabriel@creativosweb.com.co'],
    ['id' => 10, 'nombre' => 'Nombre de la empresa numero diez', 'estado' => 1, 'whatsapp'=> '573102640465', 'email' => 'sofia@creativosweb.com.co'],
    ['id' => 11, 'nombre' => 'Nombre de la empresa numero once', 'estado' => 0, 'whatsapp'=> '573102640466', 'email' => 'david@creativosweb.com.co'],
    ['id' => 12, 'nombre' => 'Nombre de la empresa numero doce', 'estado' => 1, 'whatsapp'=> '573102640467', 'email' => 'paula@creativosweb.com.co'],
    ['id' => 13, 'nombre' => 'Nombre de la empresa numero trece', 'estado' => 0, 'whatsapp'=> '573102640468', 'email' => 'mario@creativosweb.com.co'],
    ['id' => 14, 'nombre' => 'Nombre de la empresa numero catorce', 'estado' => 1, 'whatsapp'=> '573102640469', 'email' => 'luisa@creativosweb.com.co'],
    ['id' => 15, 'nombre' => 'Nombre de la empresa numero quince', 'estado' => 0, 'whatsapp'=> '573102640470', 'email' => 'jose@creativosweb.com.co'],
    ['id' => 16, 'nombre' => 'Nombre de la empresa numero dieciséis', 'estado' => 1, 'whatsapp'=> '573102640471', 'email' => 'rosa@creativosweb.com.co'],
    ['id' => 17, 'nombre' => 'Nombre de la empresa numero diecisiete', 'estado' => 0, 'whatsapp'=> '573102640472', 'email' => 'roberto@creativosweb.com.co'],
    ['id' => 18, 'nombre' => 'Nombre de la empresa numero dieciocho', 'estado' => 1, 'whatsapp'=> '573102640473', 'email' => 'carolina@creativosweb.com.co'],
    ['id' => 19, 'nombre' => 'Nombre de la empresa numero diecinueve', 'estado' => 0, 'whatsapp'=> '573102640474', 'email' => 'alberto@creativosweb.com.co'],
    ['id' => 20, 'nombre' => 'Nombre de la empresa numero veinte', 'estado' => 1, 'whatsapp'=> '573102640475', 'email' => 'veronica@creativosweb.com.co'],
    ['id' => 21, 'nombre' => 'Nombre de la empresa numero veintiuno', 'estado' => 0, 'whatsapp'=> '573102640476', 'email' => 'esteban@creativosweb.com.co'],
    ['id' => 22, 'nombre' => 'Nombre de la empresa numero veintidos', 'estado' => 1, 'whatsapp'=> '573102640477', 'email' => 'julia@creativosweb.com.co'],
    ['id' => 23, 'nombre' => 'Nombre de la empresa numero veintitres', 'estado' => 0, 'whatsapp'=> '573102640478', 'email' => 'martin@creativosweb.com.co'],
    ['id' => 24, 'nombre' => 'Nombre de la empresa numero veinticuatro', 'estado' => 1, 'whatsapp'=> '573102640479', 'email' => 'paola@creativosweb.com.co'],
    ['id' => 25, 'nombre' => 'Nombre de la empresa numero veinticinco', 'estado' => 0, 'whatsapp'=> '573102640480', 'email' => 'sergio@creativosweb.com.co'],
    ['id' => 26, 'nombre' => 'Nombre de la empresa numero veintiseis', 'estado' => 1, 'whatsapp'=> '573102640481', 'email' => 'daniel@creativosweb.com.co'],
    ['id' => 27, 'nombre' => 'Nombre de la empresa numero veintisiete', 'estado' => 0, 'whatsapp'=> '573102640482', 'email' => 'patricia@creativosweb.com.co'],
    ['id' => 28, 'nombre' => 'Nombre de la empresa numero veintiocho', 'estado' => 1, 'whatsapp'=> '573102640483', 'email' => 'victor@creativosweb.com.co'],
    ['id' => 29, 'nombre' => 'Nombre de la empresa numero veintinueve', 'estado' => 0, 'whatsapp'=> '573102640484', 'email' => 'natalia@creativosweb.com.co'],
    ['id' => 30, 'nombre' => 'Nombre de la empresa numero treinta', 'estado' => 1, 'whatsapp'=> '573102640485', 'email' => 'andres@creativosweb.com.co']
];


?>

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Usuarios</title>
    <style>
        #slideDiv { width: 500px; height: 100vh; background-color: #ffffff; position: fixed; top: 0; right: -600px; border-radius: 14px 0 0 14px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); transition: right 0.5s ease; } 
        #slideDiv.active { right: 0; } @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } } 
        @keyframes growWidth { from { width: 0; } to { width: 60%; } } #porcentajetotal div { animation: growWidth 3s ease forwards; }
        .switch input{opacity:0;width:0}.slideres{display:flex;align-items:center;position:absolute;cursor:pointer;top:10%;left:10%;right:0;bottom:0;background-color:#FD7377;transition:0.4s;border-radius:100vw}.slideres span{position:absolute;content:'';height:75%;aspect-ratio:1/1;border-radius:50%;left:8%;background-color:white;transition:0.4s}.slideres.on{background-color:#47A1A8}.slideres.off{background-color:#FD7377}.slideres.on span{transform:translateX(100%)}.slideres.off span{transform:translateX(0)}
        #slideDivcdclientes { width: 500px; height: 100vh; background-color: #ffffff; position: fixed; top: 0; right: -600px; border-radius: 14px 0 0 14px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05); transition: right 0.5s ease; } 
        #slideDivcdclientes.active { right: 0; } @keyframes floating { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } } 
    </style>
</head>
<body style="overflow:hidden;">
    
    <div style="width:100%; height:100%; box-sizing: border-box; padding-left:3%;">
        <h1 style="color:#47A1A8;">Lista de Usuarios</h1>
        <p style="font-size:1vw;">En esta sección puedes gestionar cada uno de los usuarios de la plataforma, sus datos, estados y permisos.</p>
        
        <div style="width:96%; aspect-ratio:35/1; display:flex; flex-direction:row; justify-content: space-between;">
            <div style="width:50%; height:95%; position: relative;">
                <input id="comunicadoasunto" type="text" placeholder="Asunto" style="padding-left:40px; font-size:.9vw; width:calc(99% - 40px); height:100%; border:2px solid #47A1A8; border-radius:12px;" oninput="filtrarEmpresas()">
                <span style="position: absolute; left: 10px; top: 50%; transform: translateY(-30%); color: #ccc;">
                    <img src="https://img.icons8.com/material-outlined/24/cccccc/email.png" alt="Search Icon">
                </span>
            </div>
            <select id="comunicadotipo" style="padding-left:1%; font-size:.9vw; width:22%; height:115%; background-color:#ffffff; border: 2px solid #47A1A8; border-radius:12px;" onchange="filtrarEmpresas()">
                <option value="email">Email</option>
                <option value="whatsapp">Whatsapp</option>
                <option value="sms">Mensaje de texto</option>
            </select>

            <div onclick="seleccionartodoscheckbox()" style="cursor:pointer; width:13%; height:100%; background-color:#ffffff; border-radius:10px; display:flex; align-items:center; justify-content:center; border: 2px solid #47A1A8;">
                <p style="color:#47A1A8; font-size:.9vw;">Seleccionar todo</p>
            </div>
            <div onclick="enviarcomunicado()" style="cursor:pointer; width:13%; height:100%; background-color:#47A1A8; border-radius:10px; display:flex; align-items:center; justify-content:center; border: 2px solid #47A1A8;">
                <p style="color:#ffffff; font-size:.9vw;">+ Enviar comunicado</p>
            </div>
        </div>

        <div style="width:96%; height:calc(75% - 10px); display:flex; flex-direction:row;">
            <div id="lista" style="width:70%; height:100%; margin-top:20px; overflow-y: auto; padding:10px; box-sizing:border-box;">
                <?php foreach ($usuariocomunicado as $usuariocomunicados): ?>
                    <div id="comunicadoempresa<?php echo $usuariocomunicados['id']; ?>" class="empresa" data-estado="<?php echo $usuariocomunicados['estado']; ?>" style="width:100%; aspect-ratio:25/1; margin-bottom:.6%; background-color:#F2F3F6; border-radius:.5vw; display:flex; flex-direction:row; align-items:center;">
                        <input class="destinatarios" id="comunicadoto<?php echo $usuariocomunicados['id']; ?>" type="checkbox" style="height:20px; width:20px; margin-left:1%; accent-color: #47A1A8;">
                        <p class="nombre-empresa" style="margin-left:2%; width:40%; font-size:.9vw; cursor:pointer;"><?php echo $usuariocomunicados['nombre']; ?></p>
                    </div>
                <?php endforeach; ?>
            </div>
            <div style="width:30%; height:100%; margin-top:20px;  padding:10px; box-sizing:border-box;">
                <textarea  id="mensajecomunicado" type="text"  placeholder="Escribe aquí tu mensaje. Para WhatsApp puedes usar un máximo de 300 caracteres y para SMS un máximo de 100 caracteres." style="resize:none; box-sizing:border-box; padding:4%; font-size:.9vw; width:100%; height:100%; border:2px solid #47A1A8; border-radius:12px;" oninput="filtrarEmpresas()"></textarea>
            </div>

    </div>


    <script>

        function seleccionartodoscheckbox() {
            var checkboxes = document.querySelectorAll('.destinatarios');
            var allChecked = checkboxes[0].checked;
            checkboxes.forEach(function(checkbox) {
                checkbox.checked = !allChecked;
            });
        }

        function enviarcomunicado() {
            let asunto = document.getElementById('comunicadoasunto').value;
            let comunicadotipo = document.getElementById('comunicadotipo').value;
            let mensajecomunicado = document.getElementById('mensajecomunicado').value;

            if (asunto === "") {
                alert("Por favor, ingresa el asunto.");
                return;
            }
            if (comunicadotipo === "") {
                alert("Por favor, selecciona el tipo de comunicado.");
                return;
            }
            if (mensajecomunicado === "") {
                alert("Por favor, ingresa el mensaje del comunicado.");
                return;
            }

            let usuariosSeleccionados = [];
            let checkboxes = document.querySelectorAll('.destinatarios');
            
            checkboxes.forEach(function(checkbox) {
                if (checkbox.checked) {
                    let id = checkbox.id.replace('comunicadoto', '');
                    let nombreEmpresa = document.getElementById('comunicadoempresa' + id).querySelector('.nombre-empresa').textContent;
                    
                    usuariosSeleccionados.push({
                        id: id,
                        nombre: nombreEmpresa,
                        whatsapp: checkbox.getAttribute('data-whatsapp'),
                        email: checkbox.getAttribute('data-email')
                    });
                }
            });

            if (usuariosSeleccionados.length > 0) {
                alert('Enviando comunicado ' + comunicadotipo + ' ' + asunto + ' con el mensaje: ' + mensajecomunicado);
                
                usuariosSeleccionados.forEach(function(usuario) {
                    fetch('enviarmensaje.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            'id': usuario.id,
                            'nombre': usuario.nombre,
                            'whatsapp': usuario.whatsapp,
                            'email': usuario.email,
                            'asunto': asunto,
                            'comunicadotipo': comunicadotipo,
                            'mensaje': mensajecomunicado
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log('Respuesta de envío:', data);
                    })
                    .catch(error => {
                        console.error('Error al enviar el mensaje:', error);
                    });
                });
            } else {
                alert("No se ha seleccionado ningún usuario.");
            }

            seleccionartodoscheckbox();
            asunto = '';
            comunicadotipo = '';
            mensajecomunicado = '';
        }



        
        

    </script>
</body>
</html>
